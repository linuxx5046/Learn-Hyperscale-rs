graph TD
    START["ğŸš€ Block Committed<br/>Contains Cross-Shard TXs"] --> CLASSIFY["ğŸ“Š Classify TXs<br/>- Intra-Shard<br/>- Cross-Shard"]
    
    CLASSIFY --> INTRA["âš¡ Intra-Shard<br/>Direct Execution"]
    CLASSIFY --> CROSS["ğŸ”— Cross-Shard<br/>2PC Coordination"]
    
    subgraph "Intra-Shard Execution"
        INTRA --> EXEC_INTRA["Execute TX<br/>Apply(State)"]
        EXEC_INTRA --> UPDATE_INTRA["ğŸ”„ Update State Root<br/>Local Shard"]
    end
    
    subgraph "Cross-Shard Execution (2PC)"
        CROSS --> PHASE1["ğŸ“ Phase 1: Prepare<br/>- Shard A: Reserve Resource<br/>- Shard B: Wait"]
        
        PHASE1 --> LOCK["ğŸ”’ Locks Acquired<br/>Both Shards"]
        
        LOCK --> PHASE2["âœ… Phase 2: Commit<br/>- Shard A: Execute<br/>- Shard B: Execute"]
        
        PHASE2 --> PROOF["ğŸ–ï¸ Create Proof<br/>CommitmentProof{<br/>  TXHash,<br/>  ShardA_StateRoot,<br/>  ShardB_StateRoot,<br/>  AggregatedSig<br/>}"]
        
        PROOF --> BROADCAST_PROOF["ğŸ“¢ Broadcast Proof<br/>All Shards Receive"]
    end
    
    UPDATE_INTRA --> LIVELOCK_CHECK["ğŸ” Livelock Detection<br/>Cycle Detection"]
    BROADCAST_PROOF --> LIVELOCK_CHECK
    
    LIVELOCK_CHECK --> HAS_CYCLE{"Cycle Detected?<br/>TX A â†’ B â†’ A?"}
    
    HAS_CYCLE -->|Yes| DEFER["â¸ï¸ Defer TX<br/>Next Block"]
    HAS_CYCLE -->|No| FINALIZE["âœ”ï¸ TX Finalized<br/>State Updated"]
    
    DEFER --> DEFER_QUEUE["ğŸ“‹ Deferred Queue<br/>Waiting for Resolution"]
    DEFER_QUEUE --> RETRY["ğŸ”„ Retry in Next Block"]
    RETRY --> LIVELOCK_CHECK
    
    FINALIZE --> UPDATE_LEDGER["ğŸ’¾ Update Ledger<br/>Complete History"]
    
    UPDATE_LEDGER --> END["ğŸ Block Finalized<br/>Ready for Next"]
    
    style START fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style INTRA fill:#4c6ef5,stroke:#1971c2,color:#fff
    style CROSS fill:#51cf66,stroke:#2f9e44,color:#fff
    style PROOF fill:#ffd43b,stroke:#f59f00,color:#000
    style LIVELOCK_CHECK fill:#da77f2,stroke:#9c36b5,color:#fff
    style FINALIZE fill:#9c36b5,stroke:#6c2a8f,color:#fff
