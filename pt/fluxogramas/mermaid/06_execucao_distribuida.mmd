graph TD
    START["üöÄ Bloco Commitado  
Cont√©m TXs Cross-Shard"] --> CLASSIFY["üìä Classifica TXs  
- Intra-Shard  
- Cross-Shard"]
    
    CLASSIFY --> INTRA["‚ö° Intra-Shard  
Execu√ß√£o Direta"]
    CLASSIFY --> CROSS["üîó Cross-Shard  
Coordena√ß√£o 2PC"]
    
    subgraph "Execu√ß√£o Intra-Shard"
        INTRA --> EXEC_INTRA["Execute TX  
Apply(State)"]
        EXEC_INTRA --> UPDATE_INTRA["üîÑ Atualiza State Root  
Shard Local"]
    end
    
    subgraph "Execu√ß√£o Cross-Shard (2PC)"
        CROSS --> PHASE1["üìç Fase 1: Prepare  
- Shard A: Reserva Recurso  
- Shard B: Aguarda"]
        
        PHASE1 --> LOCK["üîí Locks Adquiridos  
Ambos Shards"]
        
        LOCK --> PHASE2["‚úÖ Fase 2: Commit  
- Shard A: Executa  
- Shard B: Executa"]
        
        PHASE2 --> PROOF["üéñÔ∏è Cria Proof  
CommitmentProof{  
  TXHash,  
  ShardA_StateRoot,  
  ShardB_StateRoot,  
  AggregatedSig  
}"]
        
        PROOF --> BROADCAST_PROOF["üì¢ Broadcast Proof  
Todos Shards Recebem"]
    end
    
    UPDATE_INTRA --> LIVELOCK_CHECK["üîÅ Detec√ß√£o de Livelock  
Cycle Detection"]
    BROADCAST_PROOF --> LIVELOCK_CHECK
    
    LIVELOCK_CHECK --> HAS_CYCLE{"Ciclo Detectado?  
TX A ‚Üí B ‚Üí A?"}
    
    HAS_CYCLE -->|Sim| DEFER["‚è∏Ô∏è Defer TX  
Pr√≥ximo Bloco"]
    HAS_CYCLE -->|N√£o| FINALIZE["‚úîÔ∏è TX Finalizada  
State Atualizado"]
    
    DEFER --> DEFER_QUEUE["üìã Fila de Deferred  
Aguarda Resolu√ß√£o"]
    DEFER_QUEUE --> RETRY["üîÑ Retry em Pr√≥ximo Bloco"]
    RETRY --> LIVELOCK_CHECK
    
    FINALIZE --> UPDATE_LEDGER["üíæ Atualiza Ledger  
Hist√≥rico Completo"]
    
    UPDATE_LEDGER --> END["üèÅ Bloco Finalizado  
Pronto para Pr√≥ximo"]
    
    style START fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style INTRA fill:#4c6ef5,stroke:#1971c2,color:#fff
    style CROSS fill:#51cf66,stroke:#2f9e44,color:#fff
    style PROOF fill:#ffd43b,stroke:#f59f00,color:#000
    style LIVELOCK_CHECK fill:#da77f2,stroke:#9c36b5,color:#fff
    style FINALIZE fill:#9c36b5,stroke:#6c2a8f,color:#fff